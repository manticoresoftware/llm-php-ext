# Quick Reference: Building LLM Extension with PHP

## TL;DR

```bash
# Copy extension to PHP source
cp -r /path/to/llm-php-ext /path/to/php-src/ext/llm
cd /path/to/php-src
./buildconf --force

# Static build (embedded in PHP binary)
./configure --disable-shared --enable-llm  # Auto-detects static!
make -j$(nproc) && sudo make install
php -m | grep llm  # ✓ Works without extension=

# Shared build (separate .so file)
./configure --enable-llm  # Default
make -j$(nproc) && sudo make install
php -dextension=llm.so -m | grep llm  # ✓ Works with extension=
```

## Build Mode Detection

| Configure Flags | Result | Why |
|----------------|--------|-----|
| `--enable-llm` | Shared | Default mode |
| `--disable-shared --enable-llm` | **Static** | **Auto-detected!** |
| `--enable-static --enable-llm` | **Static** | **Auto-detected!** |
| `--enable-llm --with-llm-static` | Static | Explicit flag |

## What Gets Built

| Mode | File | Location | Usage |
|------|------|----------|-------|
| Static | `libllm.a` | `ext/llm/target/release/` | Embedded in PHP binary |
| Shared | `libllm.so` | `/usr/lib/php/extensions/` | Loaded via `extension=llm.so` |

## Verification

### Static Build
```bash
# Check symbol in binary
nm sapi/cli/php | grep get_module
# Output: 0000000012345678 T get_module

# Check extension loaded
php -m | grep llm
# Output: llm

# No php.ini needed!
php -r "var_dump(extension_loaded('llm'));"
# Output: bool(true)
```

### Shared Build
```bash
# Check .so file exists
ls -lh $(php-config --extension-dir)/llm.so
# Output: -rwxr-xr-x ... /usr/lib/php/extensions/llm.so

# Load and check
php -dextension=llm.so -m | grep llm
# Output: llm

# Add to php.ini
echo "extension=llm.so" >> /etc/php.ini
php -m | grep llm
# Output: llm
```

## Common Issues

### "cargo not found"
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
```

### "libclang not found" (Linux)
```bash
sudo apt-get install libclang-dev clang
```

### "LLVM 17 not found" (macOS)
```bash
brew install llvm@17
export LLVM_PATH=/opt/homebrew/opt/llvm@17
```

### Extension not loading (shared mode)
```bash
# Check if installed
php-config --extension-dir
ls -lh $(php-config --extension-dir)/llm.so

# If missing, reinstall
cd /path/to/php-src
sudo make install
```

### Extension not found (static mode)
```bash
# Check if symbol exists
nm sapi/cli/php | grep get_module

# If missing, rebuild
cd /path/to/php-src
make clean
./configure --disable-shared --enable-llm
make -j$(nproc)
sudo make install
```

## Requirements

- **PHP:** 8.1+
- **Rust:** 1.70+ (`rustc --version`)
- **Cargo:** Latest (`cargo --version`)
- **Clang:** 5.0+ (Linux: `libclang-dev`, macOS: LLVM 17)

## Files Involved

```
php-src/
├── ext/llm/              # Your extension (copied here)
│   ├── config.m4         # Build configuration
│   ├── Makefile.frag     # Installation rules (shared mode)
│   ├── Cargo.toml        # Rust project
│   ├── src/              # Rust source
│   └── target/           # Build output
│       └── release/
│           ├── libllm.a  # Static library
│           └── libllm.so # Shared library
└── configure             # Generated by buildconf
```

## Environment Variables

### macOS (PHP 8.5)
```bash
export LLVM_PATH=/opt/homebrew/opt/llvm@17
export LIBCLANG_PATH=$LLVM_PATH/lib
export LLVM_CONFIG_PATH=$LLVM_PATH/bin/llvm-config
```

### Linux
```bash
export LIBCLANG_PATH=/usr/lib/llvm-17/lib
# Or let config.m4 auto-detect
```

## Full Example: Static PHP with LLM

```bash
#!/bin/bash
set -e

# 1. Prepare
cd /tmp
git clone https://github.com/php/php-src.git
cd php-src
git checkout PHP-8.3  # or your version

# 2. Copy extension
cp -r /path/to/llm-php-ext ext/llm

# 3. Configure
./buildconf --force
./configure \
  --disable-shared \
  --enable-static \
  --enable-llm \
  --disable-all \
  --enable-cli \
  --enable-mbstring \
  --enable-json \
  --prefix=/opt/php-static

# 4. Build
make -j$(nproc)

# 5. Install
sudo make install

# 6. Verify
/opt/php-static/bin/php -m | grep llm
# Output: llm ✓

# 7. Test
/opt/php-static/bin/php -r "var_dump(class_exists('LLM'));"
# Output: bool(true) ✓
```

## Documentation

- **BUILD_WITH_PHP.md** - Complete build guide
- **AUTO_DETECTION.md** - Detection logic explained
- **SOLUTION_SUMMARY.md** - Summary of changes
- **CHANGES.md** - Technical details

## Support

If you encounter issues:

1. Check configure output for detection:
   ```bash
   ./configure --enable-llm 2>&1 | grep "whether to build llm"
   ```

2. Verify Rust/Cargo installed:
   ```bash
   cargo --version
   rustc --version
   ```

3. Check build logs:
   ```bash
   make 2>&1 | tee build.log
   ```

4. Verify extension built:
   ```bash
   ls -lh ext/llm/target/release/libllm.*
   ```
